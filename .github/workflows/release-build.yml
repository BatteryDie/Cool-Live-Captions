name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  windows-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2 / Mingw-w64
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja

      - name: Configure CMake (Release)
        shell: msys2 {0}
        run: >
          cmake -S . -B build
          -G "Ninja"
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          -DCMAKE_RUNTIME_OUTPUT_DIRECTORY="${{ github.workspace }}/build/bin"
          -DCMAKE_LIBRARY_OUTPUT_DIRECTORY="${{ github.workspace }}/build/bin"
          -DCMAKE_ARCHIVE_OUTPUT_DIRECTORY="${{ github.workspace }}/build/lib"

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --config Release --parallel

      - name: Install Inno Setup
        run: choco install innosetup --no-progress --yes

      - name: Build installer
        run: iscc deploy\windows-installer.iss

      - name: Rename installer to tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $source = "build/installer_output/coollivecaptionsSetup.exe"
          $dest = "build/installer_output/cool-live-captions-$tag.exe"
          if (-not (Test-Path $source)) { throw "Installer not found: $source" }
          Rename-Item -Path $source -NewName (Split-Path $dest -Leaf) -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cool-live-captions-${{ github.ref_name }}
          path: build/installer_output/cool-live-captions-${{ github.ref_name }}.exe

      - name: Publish GitHub Release asset
        uses: softprops/action-gh-release@v2
        with:
          files: build/installer_output/cool-live-captions-${{ github.ref_name }}.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linux-release-appimage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            libgl1-mesa-dev libglu1-mesa-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxi-dev libxcursor-dev \
            libxkbcommon-dev libwayland-dev wayland-protocols \
            libpipewire-0.3-dev libspa-0.2-dev

      - name: Configure CMake (Release)
        run: |
          cmake -S . -B build-linux-release \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build
        run: cmake --build build-linux-release --parallel

      - name: Make AppImage script executable
        run: chmod +x deploy/linux-appimage.sh

      - name: Build AppImage
        env:
          BUNDLE_AUDIO_LIBS: 1
        run: ./deploy/linux-appimage.sh

      - name: Collect AppImage artifact
        run: |
          src="build-appimage/Cool Live Caption.AppImage"
          dest="build/coollivecaptions-x86_64.AppImage"
          mkdir -p build
          if [ ! -f "$src" ]; then
            echo "AppImage not found at $src"
            ls -l build-appimage || true
            exit 1
          fi
          mv "$src" "$dest"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: cool-live-captions-appimage-${{ github.ref_name }}
          path: build/coollivecaptions-x86_64.AppImage

      - name: Publish GitHub Release asset (AppImage)
        uses: softprops/action-gh-release@v2
        with:
          files: build/coollivecaptions-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
